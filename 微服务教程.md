# Docker命令



##### 先移除掉exited状态的容器 ,然后删除dangling状态的镜像(悬虚镜像)

```shell
docker rm $(docker ps -q -f status=exited)
docker rmi $(docker images -q -f dangling=true)
```

##### 查看是否存在具有特定名称的Docker容器

```shell
if [ ! "$(docker ps -q -f name=mysql80)" ]; then  //判断该容器是否存在
    if [ "$(docker ps -aq -f status=exited -f name=mysql80)" ]; then
        # cleanup
        docker rm mysql80
    fi
    # run your container
    docker run -d -p 3306:3306 -p 33060:33060 --volume "$MYSQLFOLDERLOCATION":/var/lib/mysql --name mysql80 frostedflakez/php-mysql-webserver:0.9-beta.3-mysql-latest-8.0
fi
```

##### 删除所有容器

```shell
docker rm `docker ps -a -q`
```

##### 删除所有镜像

```shell
docker rmi `docker images -q`
```

##### 按条件删除镜像

###### 没有打标签

```shell
docker rmi "`docker images -q | awk '/^<none>/ { print $3 }'`"
```

###### 镜像名包含关键字

```shell
docker rmi --force `docker images | grep doss-api | awk '{print $3}'`    //其中doss-api为关键字
```

##### 清理镜像

我们在使用 Docker 一段时间后，系统一般都会残存一些临时的、没有被使用的镜像文件，可以通过以下命令进行清理

```shell
docker image prune
```

它支持的子命令有：

- `-a, --all`: 删除所有没有用的镜像，而不仅仅是临时文件；
- `-f, --force`：强制删除镜像文件，无需弹出提示确认；

另外，执行完 `docker image prune` 命令后，还是告诉我们释放了多少存储空间！

##### 删除所有Tag是v开头的镜像

```shell
docker images --format "{{.Repository}}:{{.Tag}}" | grep ":v" | awk '{system("docker rmi "$1)}'
```

##### 要启动所有已停止的容器，你可以使用以下步骤：

1. 使用以下命令列出所有已停止的容器的ID：

```
docker ps -a -q --filter "status=exited"
```

1. 使用 `docker start` 命令结合上述命令启动所有已停止的容器：

```
docker start $(docker ps -a -q --filter "status=exited")
```



### 清理docker

Docker 的容器、镜像、卷和网络可能会占用大量的磁盘空间。为了清理不再需要的 Docker 资源并释放磁盘空间，你可以使用以下命令：

1. **清理停止的容器**：

   ```
   docker container prune
   ```
   
2. **清理未使用的镜像**：

   - 删除悬挂的镜像（即未被任何容器使用的镜像）：

     ```
     docker image prune
     ```
     
   - 删除所有未被任何容器使用的镜像：
   
     ```
     docker image prune -a
     ```
   
3. **清理未使用的卷**：

   ```
   docker volume prune
   ```
   
4. **清理未使用的网络**：

   ```
   docker network prune
   ```
   
5. **一次性清理停止的容器、未使用的网络、悬挂的镜像和未使用的卷**：

   ```
   docker system prune
   ```
   
   如果你也想删除所有未被容器使用的镜像（而不仅仅是悬挂的镜像），可以添加 `-a` 选项：
   
   ```
   docker system prune -a
   ```

**注意**：在使用上述命令之前，请确保你确实不再需要这些资源，因为这些操作是不可逆的。特别是当你清理镜像或卷时，重新获取或创建它们可能需要一些时间。

# Docker Swarm

容器编排



# Kubernetes

### 安装minikube(学习环境，非生产环境)

```
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube && rm minikube-linux-amd64
```

### 在Dokcer安装并运行kubernetes

```
 minikube start --force --driver=docker
```

###  Curl 在 Linux 系统中安装 kubectl

```
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
```

### 安装 kubectl

```
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

### 查看版本的详细信息

```
kubectl version --client --output=yaml
```

### 运行Nginx（测试）

```shell
kubectl run ngx --image=nginx:alpine
```

### 查看kubectl的文档

```shell
kubectl explain pod
```

### kubectl命令

#### 查看所有pod

```shell
kubectl get pods --all-namespaces
```

#### 查看pod详情

```shell
kubectl describe pod <NAME> -n <NAMESPACE>
```

#### **查询所有命名空间中的所有 Job**

```shell
kubectl get jobs --all-namespaces
```

#### **删除 Job**

```shell
kubectl delete job <name> -n consul
```





# jenkins

## 部署

```shell
docker run -u root -d --privileged -p 8080:8080 -p 50000:50000 --restart=always -v /data/jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock -v /etc/ssl/certs:/usr/local/share/ca-certificates:ro --name jenkins jenkins/jenkins:lts-jdk17
```

## 进入jenkins容器

```
docker exec -it -u root jenkins bash
```

## 在容器内安装Docker CLI（Debian/Ubuntu系统）：

```shell
apt-get update
apt-get install -y docker.io
```

## 更新证书(先进入jenkins容器)

```
update-ca-certificates 
```

## 解决dotnet构建错误

> jenkins安装.net sdk插件后运行dotnet命令后报错
>
> Process terminated. Couldn't find a valid ICU package installed on the system. Please install libicu (or icu-libs) using your package manager and try again. Alternatively you can set the configuration flag System.Globalization.Invariant to true if you want to run with no globalization support. Please see https://aka.ms/dotnet-missing-libicu for more information.

```shell
export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
dotnet nuget add source http://192.168.0.252/v3/index.json -n queyouquan
dotnet nuget list source
```

# Consul



# 使用prometheus监控服务

## docker安装prometheus

```shell
docker run -p 9090:9090 -v /path/to/config:/etc/prometheus prom/prometheus --restart=always
```

## docker安装grafana可视化工具

```shell
docker run -d -p 3000:3000 --name=grafana grafana/grafana
```

# Container Advisor容器监控

> Github：https://github.com/google/cadvisor



# 分布式链路追踪

## OpenTelemetry 标准(链路追踪+指标+日志)

### SkyWalking

**架构**: SkyWalking 的架构更为复杂，包含了 Agent、Collector、Storage、UI 等多个组件。它的 Agent 可以嵌入在应用中，收集详细的指标数据和追踪信息。

**功能**:

- 分布式追踪和性能监控
- 全面的指标收集（如 JVM 指标、数据库性能、容器指标等）
- 服务依赖分析和拓扑图展示
- 告警机制，支持自定义告警策略
- 多租户支持和高可用架构
- 支持多种存储后端（Elasticsearch、H2、MySQL、TiDB 等）
- 支持多语言的探针（Java、.NET Core、Node.js、Go 等）

**优势**:

- 对复杂系统的支持更强，适合企业级应用
- 丰富的监控和分析功能，不仅限于分布式追踪
- 可扩展性强，适合与其他监控工具集成

#### Docker-Compose安装部署

```yaml
name: skywalking-standalone

networks:
  skywalking-network:

services:
  skywalking-oap:
    image: apache/skywalking-oap-server
    container_name: oap
    environment:
      TZ: Asia/Shanghai
      SW_HEALTH_CHECKER: default
      SW_TELEMETRY: prometheus
    ports:
      - "2800:12800"
      - "1800:11800"
    networks:
      - skywalking-network
    healthcheck:
      test: [ "CMD-SHELL", "curl http://localhost:12800/internal/l7check" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: always  # 添加 restart 策略

  skywalking-ui:
    image: apache/skywalking-ui
    container_name: oap-ui
    ports:
      - "8088:8080"
    environment:
      SW_OAP_ADDRESS: http://oap:12800
    networks:
      - skywalking-network
    depends_on:
      skywalking-oap:
        condition: service_healthy
    restart: always  # 添加 restart 策略

```



#### 与ASP.NET Core 集成

文档地址：https://github.com/SkyAPM/SkyAPM-dotnet

安装package **SkyAPM.Agent.AspNetCore** 

```
dotnet add package SkyAPM.Agent.AspNetCore
```

设置环境变量

```
ASPNETCORE_HOSTINGSTARTUPASSEMBLIES=SkyAPM.Agent.AspNetCore
SKYWALKING__SERVICENAME=sample_app
```

安装`SkyAPM.DotNet.CLI`



### Zipkin

**架构**: Zipkin 的架构相对简单，包括追踪器、收集器、存储和 UI 组件。它支持多种数据存储后端，如 MySQL、Elasticsearch 等。

**功能**:

- 追踪请求路径和延迟
- 展示请求传播的时间线图
- 支持多种语言的客户端（Java、.NET、Go、Python 等）
- 提供基于 HTTP 的 API，供用户查询和存储追踪数据

**局限性**:

- 不具备 SkyWalking 那样的全面监控功能
- 不直接提供告警机制
- 对于复杂的依赖关系分析能力较弱

#### Docker-Compose安装部署

```yaml
name: zipkin-standalone

networks:
  zipkin-network:

services:
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin
    ports:
      - "9411:9411"
    environment:
      - STORAGE_TYPE=mem
    networks:
      - zipkin-network
```

#### ASP.NET Core 集成 OpenTelemetry

```
dotnet add package OpenTelemetry.Exporter.Zipkin
dotnet add package OpenTelemetry.Extensions.Hosting
dotnet add package OpenTelemetry.Instrumentation.AspNetCore
```

